{% extends "base.html" %}

{% block title %}图床转发 - 管理合集 {{ collection_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏：操作区 -->
        <div class="col-md-3 col-lg-2 sidebar py-3">
            <h5>合集操作</h5>
            <hr>
            <div class="mb-3">
                <a href="{{ url_for('admin.index') }}" class="btn btn-secondary btn-sm w-100 mb-2">返回管理面板</a>
                <form method="post" action="{{ url_for('admin.delete_collection') }}" onsubmit="return confirm('确定要删除整个合集吗？此操作无法撤销！');">
                    <input type="hidden" name="collection_name" value="{{ collection_name }}">
                    <button type="submit" class="btn btn-danger btn-sm w-100">删除此合集</button>
                </form>
            </div>

            <h5>上传图片</h5>
            <form method="post" action="{{ url_for('admin.upload_image', collection_name=collection_name) }}" enctype="multipart/form-data" class="mb-4">
                <div class="mb-3">
                    <label for="image" class="form-label">选择图片文件</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                    <div class="form-text">最大20MB</div>
                </div>
                <button type="submit" class="btn btn-primary w-100">上传图片</button>
            </form>

            <h5>添加外链</h5>
            <form method="post" action="{{ url_for('admin.add_links', collection_name=collection_name) }}" class="mb-4">
                <div class="mb-3">
                    <label for="links" class="form-label">图片外链地址</label>
                    <textarea class="form-control" id="links" name="links" rows="5" placeholder="每行一个链接，以http://或https://开头" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">添加外链</button>
            </form>
        </div>

        <!-- 主内容区 -->
        <div class="col-md-9 col-lg-10 py-3">
            <h1>管理合集: {{ collection_name }}</h1>
            <p class="lead">
                随机获取图片: <code>{{ request.host_url }}{{ collection_name }}</code>
                <a href="{{ request.host_url }}{{ collection_name }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">测试</a>
            </p>

            <!-- 本地图片管理 -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">本地图片 ({{ images|length }}张)</h5>
                </div>
                <div class="card-body">
                    {% if images %}
                    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
                        {% for image in images %}
                        <div class="col">
                            <div class="card image-card">
                                <div class="image-container">
                                    <img src="{{ image.url }}" class="image-preview" alt="{{ image.name }}">
                                </div>
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <small class="text-muted text-truncate me-2">{{ image.name }}</small>
                                    <div>
                                        <a href="{{ image.url }}" target="_blank" class="btn btn-sm btn-primary">查看</a>
                                        <form method="post" action="{{ url_for('admin.delete_image', collection_name=collection_name) }}" class="d-inline" onsubmit="return confirm('确定要删除此图片吗？');">
                                            <input type="hidden" name="image_name" value="{{ image.name }}">
                                            <button type="submit" class="btn btn-sm btn-danger">删除</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <p>该合集中还没有本地图片。使用左侧上传功能添加图片。</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 外链管理 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">外链图片 ({{ links|length }}个)</h5>
                </div>
                <div class="card-body">
                    {% if links %}
                    <div class="list-group">
                        {% for link in links %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div class="text-truncate me-3">{{ link }}</div>
                            <div>
                                <a href="{{ link }}" target="_blank" class="btn btn-sm btn-primary">查看</a>
                                <form method="post" action="{{ url_for('admin.delete_link', collection_name=collection_name) }}" class="d-inline" onsubmit="return confirm('确定要删除此外链吗？');">
                                    <input type="hidden" name="link" value="{{ link }}">
                                    <button type="submit" class="btn btn-sm btn-danger">删除</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <p>该合集中还没有外链图片。使用左侧添加功能添加外链。</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}